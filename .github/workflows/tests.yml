on: [workflow_call]

permissions: {}

env:
  WINDOWS_USERPROFILE: 'D:'

jobs:
  test:
    name: üß™ Tests
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      # https://ichard26.github.io/blog/2025/03/faster-pip-ci-on-windows-d-drive/#moving-temp-to-the-d-drive
      - name: üóÇÔ∏è Set temp dir on Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $TEMP_DIR = "$env:WINDOWS_USERPROFILE\Temp"
          # Create temp dir
          New-Item -ItemType Directory -Force -Path $TEMP_DIR | Out-Null

          "TEMP=$TEMP_DIR"  >> $env:GITHUB_ENV
          "TMP=$TEMP_DIR"   >> $env:GITHUB_ENV

      - name: üîì Disable Windows Defender
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          Set-MpPreference -DisableRealtimeMonitoring $true
          # Exclude Bun directories from scanning
          Add-MpPreference -ExclusionPath "$env:WINDOWS_USERPROFILE\.bun"
          Add-MpPreference -ExclusionPath "$env:RUNNER_TEMP"
          Add-MpPreference -ExclusionPath "$env:GITHUB_WORKSPACE"

      - name: üõú Network tweaks for Windows
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          # Use Google DNS (https://github.com/oven-sh/bun/issues/4066#issuecomment-1777701194)
          Get-NetAdapter | ForEach-Object { Set-DnsClientServerAddress -InterfaceIndex $_.InterfaceIndex -ServerAddresses ("8.8.8.8", "8.8.4.4") }

          # Disable IPv6 (https://github.com/oven-sh/bun/issues/4938#issuecomment-1720172113)
          Get-NetAdapterBinding -ComponentID ms_tcpip6 | ForEach-Object { Disable-NetAdapterBinding -InterfaceAlias $_.Name -ComponentID ms_tcpip6 }

          # Optimize TCP settings
          netsh int tcp set global autotuninglevel=normal
          netsh int tcp set global chimney=enabled
          netsh int tcp set global rss=enabled
          netsh int tcp set global netdma=enabled
          netsh int tcp set global ecncapability=enabled

          # Increase concurrent TCP connections
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -Name "MaxUserPort" -Value 65534 -Type DWord
          Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" -Name "TcpTimedWaitDelay" -Value 30 -Type DWord

      - name: üì• Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
          sparse-checkout-cone-mode: false
          # Download only the necessary files
          sparse-checkout: |
            src
            tests
            package.json
            bun.lock
            bunfig.toml
            tsup.config.ts
            tsconfig*.json
            !**/*.md

      - name: üîß Setup Bun
        uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5 # v2
        env:
          USERPROFILE: ${{ env.WINDOWS_USERPROFILE }}
        with:
          bun-version: latest

      - name: üì• Cache Bun dependencies
        # Run only on Windows because on Linux there are no problems with slow package installation
        if: runner.os == 'Windows'
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4
        env:
          USERPROFILE: ${{ env.WINDOWS_USERPROFILE }}
        with:
          path: '${{ env.USERPROFILE }}\.bun'
          key: ${{ matrix.os }}-bun-${{ hashFiles('**/bun.lock') }}

      # The main bottleneck is here, `bun install` takes too long on Windows
      # @oven-sh Please fix this üôè
      - name: üì¶ Install dependencies
        run: bun install --frozen-lockfile

      - name: üß™ Run tests
        run: bun run test
