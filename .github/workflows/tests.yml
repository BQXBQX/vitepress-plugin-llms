on: [workflow_call]

permissions: {}

jobs:
  test:
    name: ðŸ§ª Tests
    strategy:
      fail-fast: false
      matrix:
        # Use older `windows-2019` for greater speed
        # See https://github.com/actions/runner-images/issues/5166
        os: [ubuntu-latest, windows-2019]

    runs-on: ${{ matrix.os }}

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
          sparse-checkout-cone-mode: false
          # Download only the necessary files
          sparse-checkout: |
            src
            tests
            package.json
            bun.lock
            bunfig.toml
            tsup.config.ts
            tsconfig*.json
            !**/*.md

      - name: ðŸ”§ Setup Bun
        uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5 # v2
        with:
          bun-version: latest

      - name: ðŸ“¥ Cache Bun dependencies
        # Run only on Windows because on Linux there are no problems with slow package installation
        if: matrix.os == 'windows-latest'
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4
        with:
          path: |
            ~\.bun
          key: ${{ matrix.os }}-bun-${{ hashFiles('**/bun.lock') }}

      - name: ðŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ðŸ§ª Run tests
        run: bun run test
